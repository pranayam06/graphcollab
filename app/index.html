<html>
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litegraph.js/css/litegraph.css">
  <script src="https://cdn.jsdelivr.net/npm/litegraph.js/build/litegraph.min.js"></script>
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  <style>
    body { margin:0; font-family: sans-serif; display:flex; flex-direction:column; height:100vh; }
    #toolbar {
      display:flex; align-items:center; padding:10px; background:#2c3e50; color:white; gap:10px;
    }
    #toolbar {display:flex; align-items:center;
  padding:15px;
  background:#2c3e50; color:white;
  gap:10px; height:60px;
}
#toolbar button {
  z-index: 10;
  position: relative; /* keep it above absolute panels */
}
#toolbar input, #toolbar button {
  padding:7px 12px; border:none; border-radius:4px; font-size:14px;
}
    #toolbar button { cursor:pointer; background:#3498db; color:white; }
    #toolbar button:hover { background:#2980b9; }
    #mycanvas { flex:1; border-top:1px solid #ccc; width:100%; display: block; }
    #collaborators li::before {
    content: '';
    display: inline-block;
    width: 10px;
    height: 10px;
    background: #3b4258;
    border-radius: 50%;
    margin-right: 8px;
}
  </style>
</head>
<body>
  <div id="toolbar">
    <input id="userId" placeholder="User ID">
    <input id="roomId" placeholder="Room ID">
    <button id="joinRoomBtn">Join Room</button> 
    <button id="historyBtn" style="margin-left: 700px;">History</button>

  </div>
  <div id="collaborators" style="
  position:absolute;
  top:0; right:0;
  width:200px;
  height:100%;
  background:#b1b2b6;
  padding:10px;
  overflow-y:auto;
  display:none;
"> 
<h3 style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px; margin-left: 8px">
  Collaborators
</h3>
  <ul style="list-style:none; padding:0; margin:0;" id="collaboratorsList">
  </ul>
</div>
<div id="historyPanel" style="
  position:absolute;
  top:0; right:210px;
  width:300px;
  height:100%;
  background:#f5f5f5;
  padding:10px;
  overflow-y:auto;
  display:none;
  border-left:1px solid #ccc;
"> 
  <h3>Room History</h3>
  <ul id="historyList" style="list-style:none; padding:0; margin:0;"></ul>
</div>
  <canvas id="mycanvas"></canvas> 
  <div id="overlay" style="
  display:none;
  position:absolute;
  top:0; left:0;
  width:100%;
  height:100%;
  z-index:999;
"></div>

<script type="module"> 
import * as Y from "https://esm.sh/yjs@13"

// High-DPI scaling
const canvasEl = document.getElementById("mycanvas");
const ctx = canvasEl.getContext("2d");
const dpr = window.devicePixelRatio || 1;
canvasEl.width = canvasEl.clientWidth * dpr;
canvasEl.height = canvasEl.clientHeight * dpr;
ctx.scale(dpr, dpr); 

const ydoc = new Y.Doc();
const ymap = ydoc.getMap("graph");
let roomId = null;
let userId = null;


function deepClone(obj) { return JSON.parse(JSON.stringify(obj)); }
function deepEqual(a,b) { return JSON.stringify(a)===JSON.stringify(b); } 

let applyingRemoteUpdate = false;

// Extend LGraph
class LGraphPro extends LGraph {
  constructor() { super(); this._graph_cache = {}; }
  emit(...args){ 
    if(this.events) this.events.emit(...args); }
  change(){ 
    super.change(); 
    this.emit("change"); 
    this.checkGraphChange(); 
}
  
    connectionChange(node){ 
        if(super.connectionChange) super.connectionChange(node); 
        this.emit("connection_change", node); 
        this.checkGraphChange(); 
    }
  
    serializeDeep(options={}) {
    const g=this.serialize();
    g.nodes.sort((a,b)=>a.id-b.id);
    if(options.skip_inputs) g.nodes.forEach(x=>x.inputs=[]);
    if(options.skip_outputs) g.nodes.forEach(x=>x.outputs=[]);
    if(options.skip_properties) g.nodes.forEach(x=>x.properties={});
    if(options.skip_links) g.links=[];
    if(options.skip_nodes) g.nodes=[];
    return deepClone(g);
  }
  checkGraphChange() {
    if (applyingRemoteUpdate) return;  // ignore remote updates
    const g = this.serializeDeep({ skip_inputs:true, skip_outputs:true, skip_properties:true });
    if (deepEqual(g, this._graph_cache)) return;
    this._graph_cache = g; 
    console.log("are we here chat");

    //this.emit("graph_change", this.serializeDeep()); 
    console.log((userId));
    if (!ydoc || !roomId || !userId) return; 
    console.log((ydoc));
    ymap.set("graph", this.serializeDeep());
    const update = Array.from(Y.encodeStateAsUpdate(ydoc)); 
    console.log("right before dispatching event");
    document.dispatchEvent(new CustomEvent("graph-update", { detail: update }));
    //listen_for_change(this.serializeDeep())
    //document.dispatchEvent(new CustomEvent("graphJSONUpdated", { detail: this.serializeDeep() }));
  }

}



// Create graph
var graph = new LGraphPro();
var canvas = new LGraphCanvas("#mycanvas", graph); 


function listen_for_change(graphJSON) {
  if (!ydoc || !roomId || !userId) return;

  // Store the whole graph under a single key
  ymap.set("graph", graphJSON);

  // Encode incremental update
  const update = Array.from(Y.encodeStateAsUpdate(ydoc));

  // Send via Socket.io # move this somewhere else 
  document.dispatchEvent(new CustomEvent("graphJSONUpdated", { detail: this.serializeDeep() }));
  socket.emit("graph-update", update);
}


function update_graph(json) {
    // Temporarily block events
    applyingRemoteUpdate = true;

    // Apply remote JSON to the graph
    graph.configure(json); 
    // HERE UPDATE 

    console.log(json)
    
    // Sync cache manually so future local edits are detected
    graph._graph_cache = graph.serializeDeep({ skip_inputs:true, skip_outputs:true, skip_properties:true });

    applyingRemoteUpdate = false;
}

window.recieve_update = function(arr) {
  // Apply the Yjs update
  console.log("OMG WERE HERE")
  console.log(typeof(arr))
  const update = new Uint8Array(arr);
  console.log(typeof(update))
  Y.applyUpdate(ydoc, update);

  // Get the latest graph JSON from Yjs
  const graphJSON = ymap.get("graph");

  if (graphJSON) {
    // Update LiteGraph
    applyingRemoteUpdate = true;
    graph.configure(graphJSON);
    graph._graph_cache = graph.serializeDeep({ skip_inputs:true, skip_outputs:true, skip_properties:true });
    applyingRemoteUpdate = false;
  }
}; 

 window.temp_remote_update = function(updates) {
    applyingRemoteUpdate = true;
    for (const u of updates) {
      Y.applyUpdate(ydoc, new Uint8Array(u));
    }
    const graphJSON = ymap.get("graph");
    update_graph(graphJSON);
    applyingRemoteUpdate = false;
  } 

// Wrap sum node
function sum(a,b){ return a+b; }
LiteGraph.wrapFunctionAsNode("math/sum", sum, ["Number","Number"], "Number");

// Add demo nodes
var n1 = LiteGraph.createNode("math/sum"); n1.pos=[200,200]; graph.add(n1);
var n2 = LiteGraph.createNode("math/sum"); n2.pos=[400,200]; graph.add(n2);

function freezeGraph() {
  const overlay = document.getElementById("overlay");
  overlay.style.display = "block";
}

function unfreezeGraph(){ 
  const overlay = document.getElementById("overlay");
  overlay.style.display = "none";
}

const historyBtn = document.getElementById("historyBtn");
  const historyPanel = document.getElementById("historyPanel");
  const historyList = document.getElementById("historyList");

  // Toggle panel
  historyBtn.addEventListener("click", () => {
    historyPanel.style.display =
      historyPanel.style.display === "none" ? "block" : "none"; 
      document.dispatchEvent(new CustomEvent("historyRequest", {})) 
      console.log("history button pressed");
      // freezeGraph()  
  });

  // Function to render versions
  window.renderHistory = function(versions) {
    historyList.innerHTML = "";
    versions.forEach((version, index) => {
      const li = document.createElement("li");
      li.textContent = `Version ${index + 1} (${new Date(version.timestamp).toLocaleTimeString()})`;
      li.style.cursor = "pointer";
      li.onclick = () => {
        console.log("Requesting version", index);
        document.dispatchEvent(new CustomEvent("loadVersion", { detail: index }));
      };
      historyList.appendChild(li);
    });
  }



// --- BUTTONS ---

document.getElementById("joinRoomBtn").addEventListener("click", ()=>{
  userId = document.getElementById("userId").value.trim();
  roomId = document.getElementById("roomId").value.trim();
  if(!userId || !roomId) { alert("Enter User ID and Room ID"); return; }

  alert(`You are now joining room ${roomId} as user ${userId}`);
  // TODO: connect to WebSocket / Yjs for collaborative editing
});
</script>
<script src="app.js"></script>
</body></html>
